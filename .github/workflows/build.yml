name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'
      create_release:
        description: 'Create GitHub Release'
        required: true
        default: true
        type: boolean
      build_gui:
        description: 'Build GUI version'
        required: true
        default: true
        type: boolean

jobs:
  build:
    strategy:
      matrix:
        os: [windows-latest, macos-latest]
        include:
          - os: windows-latest
            platform: Windows
            ext: .exe
            archive_cmd: 7z a
            archive_ext: .zip
          - os: macos-latest
            platform: macOS
            ext: ""
            archive_cmd: tar -czf
            archive_ext: .tar.gz
    
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        elif [ "${{ github.event_name }}" = "push" ] && [[ "${{ github.ref }}" == refs/tags/* ]]; then
          VERSION="${{ github.ref_name }}"
          # Remove 'v' prefix if present
          VERSION=${VERSION#v}
        else
          VERSION="1.0.0"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Using version: $VERSION"

    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install 7zip (Windows)
      if: matrix.os == 'windows-latest'
      run: choco install 7zip -y

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build CLI executable
      run: |
        pyinstaller --onefile --name AutoYuque-CLI${{ matrix.ext }} main.py

    - name: Build GUI executable
      if: github.event.inputs.build_gui == 'true' || github.event.inputs.build_gui == null
      run: |
        pyinstaller --onefile --windowed --name AutoYuque-GUI${{ matrix.ext }} gui.py

    - name: Create build directory
      shell: bash
      run: |
        mkdir -p AutoYuque_Build
        cp dist/AutoYuque-CLI${{ matrix.ext }} AutoYuque_Build/
        if [ -f "dist/AutoYuque-GUI${{ matrix.ext }}" ]; then
          cp dist/AutoYuque-GUI${{ matrix.ext }} AutoYuque_Build/
        fi
        cp config.json AutoYuque_Build/
        cp README.md AutoYuque_Build/
        cp LICENSE AutoYuque_Build/
        cp GUI_README.md AutoYuque_Build/ || true

    - name: Create archive (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        7z a AutoYuque_V${{ steps.version.outputs.VERSION }}_${{ matrix.platform }}${{ matrix.archive_ext }} AutoYuque_Build

    - name: Create archive (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        tar -czf AutoYuque_V${{ steps.version.outputs.VERSION }}_${{ matrix.platform }}${{ matrix.archive_ext }} AutoYuque_Build

    - name: Upload Release Assets
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
      with:
        tag_name: v${{ steps.version.outputs.VERSION }}
        name: Auto-Yuque v${{ steps.version.outputs.VERSION }} å¤šå¹³å°å‘å¸ƒ
        body: |
          ## ğŸš€ Auto-Yuque v${{ steps.version.outputs.VERSION }} å…¨æ–°å‘å¸ƒ
          
          ### âœ¨ æ ¸å¿ƒåŠŸèƒ½
          - ğŸ” **æ™ºèƒ½ç™»å½•ç®¡ç†** - Cookie æŒä¹…åŒ–ï¼Œå…é‡å¤ç™»å½•
          - ğŸ“ **æ™ºèƒ½å°è®°** - å¿«é€Ÿåˆ›å»ºä¸ç®¡ç†ï¼Œè‡ªåŠ¨åŒ–ç”Ÿå‘½å‘¨æœŸ
          - ğŸŒŸ **ç¤¾åŒºäº’åŠ¨** - AIæ™ºèƒ½ç‚¹èµå›å¤ï¼Œæå‡ç¤¾åŒºå‚ä¸åº¦
          - ğŸ“š **çŸ¥è¯†ç®¡ç†** - è‡ªåŠ¨åŒ–æ–‡æ¡£åˆ›å»ºï¼Œé«˜æ•ˆå†…å®¹ç»„ç»‡
          - ğŸ‘¥ **ç”¨æˆ·å‘ç°** - ç²¾å‡†å…³æ³¨ä¼˜è´¨åˆ›ä½œè€…ï¼Œæ‰©å±•äººè„‰ç½‘ç»œ
          - ğŸ¤– **AIè¯„è®ºç”Ÿæˆ** - é«˜è´¨é‡æ™ºèƒ½è¯„è®ºï¼Œå¢å¼ºäº’åŠ¨ä½“éªŒ
          
          ### ğŸ“¦ å¤šå¹³å°æ”¯æŒ
          
          #### Windows ç”¨æˆ·
          1. ä¸‹è½½ `AutoYuque_V${{ steps.version.outputs.VERSION }}_Windows.zip`
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œ `AutoYuque-GUI.exe`ï¼ˆå›¾å½¢ç•Œé¢ï¼‰æˆ– `AutoYuque-CLI.exe`ï¼ˆå‘½ä»¤è¡Œï¼‰
          
          #### macOS ç”¨æˆ·
          1. ä¸‹è½½ `AutoYuque_V${{ steps.version.outputs.VERSION }}_macOS.tar.gz`
          2. è§£å‹ï¼š`tar -xzf AutoYuque_V${{ steps.version.outputs.VERSION }}_macOS.tar.gz`
          3. è¿è¡Œ `./AutoYuque-GUI`ï¼ˆå›¾å½¢ç•Œé¢ï¼‰æˆ– `./AutoYuque-CLI`ï¼ˆå‘½ä»¤è¡Œï¼‰
          
          ### ğŸ¯ ä½¿ç”¨æŒ‡å—
          1. **é¦–æ¬¡é…ç½®**ï¼šè®¾ç½® ChromeDriver è·¯å¾„
          2. **ç™»å½•éªŒè¯**ï¼šæ‰«ç ç™»å½•è¯­é›€è´¦å·
          3. **åŠŸèƒ½é€‰æ‹©**ï¼šæ ¹æ®éœ€æ±‚é€‰æ‹©å¯¹åº”åŠŸèƒ½æ¨¡å—
          4. **æ™ºèƒ½è¿è¡Œ**ï¼šäº«å—è‡ªåŠ¨åŒ–å¸¦æ¥çš„ä¾¿åˆ©
          
          ### âš ï¸ é‡è¦æé†’
          - ğŸ“‹ éœ€è¦å®‰è£… Chrome æµè§ˆå™¨åŠå¯¹åº”ç‰ˆæœ¬çš„ ChromeDriver
          - ğŸ”‘ é¦–æ¬¡ä½¿ç”¨éœ€è¦ç™»å½•è¯­é›€è´¦å·è¿›è¡Œæˆæƒ
          - ğŸ“– è¯·éµå®ˆè¯­é›€å¹³å°ä½¿ç”¨è§„åˆ™ï¼Œåˆç†ä½¿ç”¨è‡ªåŠ¨åŒ–åŠŸèƒ½
          - ğŸ›¡ï¸ å»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒä¸­å…ˆè¡ŒéªŒè¯åŠŸèƒ½æ•ˆæœ
          
          ### ğŸ†• æœ¬ç‰ˆæœ¬æ›´æ–°
          - ğŸ¨ ä¼˜åŒ–ç•Œé¢è®¾è®¡ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
          - ğŸ”§ å¢åŠ å¤šå¹³å°æ”¯æŒï¼ˆWindows & macOSï¼‰
          - ğŸ“± æä¾›GUIå’ŒCLIåŒç‰ˆæœ¬é€‰æ‹©
          - ğŸš€ æ”¹è¿›æ„å»ºæµç¨‹ï¼Œæé«˜ç¨³å®šæ€§
        draft: false
        prerelease: false
        files: |
          AutoYuque_V${{ steps.version.outputs.VERSION }}_${{ matrix.platform }}${{ matrix.archive_ext }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
