name: Auto-Yuque Build and Release

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
      packages: write

    env:
      VERSION: '1.0.0'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install 7zip
      run: |
        choco install 7zip -y

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build executable
      run: |
        pyinstaller --onefile --name AutoYuque main.py

    - name: Create build directory
      run: |
        mkdir AutoYuque_Build
        cp dist/AutoYuque.exe AutoYuque_Build/
        cp config.json AutoYuque_Build/
        cp README.md AutoYuque_Build/
        cp LICENSE AutoYuque_Build/

    - name: Create ZIP file
      run: |
        7z a AutoYuque_V${{ env.VERSION }}_Windows.zip AutoYuque_Build

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        tag_name: v${{ env.VERSION }}
        name: Auto-Yuque v${{ env.VERSION }} Release
        body: |
          ## ğŸš€ Auto-Yuque v${{ env.VERSION }} å‘å¸ƒ
          
          ### âœ¨ æ–°ç‰¹æ€§
          - ğŸ” æ™ºèƒ½ç™»å½•ç®¡ç† - æ”¯æŒ Cookie æŒä¹…åŒ–
          - ğŸ“ å°è®°è‡ªåŠ¨åŒ– - å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
          - ğŸŒŸ ç¤¾åŒºäº’åŠ¨ - æ™ºèƒ½ç‚¹èµå’Œå†…å®¹æŠ“å–
          - ğŸ“š çŸ¥è¯†åº“ç®¡ç† - è‡ªåŠ¨åˆ›å»ºå’Œç®¡ç†æ–‡æ¡£
          - ğŸ‘¥ ç”¨æˆ·å…³æ³¨ - æ™ºèƒ½å‘ç°å’Œå…³æ³¨ä¼˜è´¨ç”¨æˆ·
          - ğŸ¤– AI è¯„è®ºç”Ÿæˆ - é«˜è´¨é‡è¯„è®ºè‡ªåŠ¨ç”Ÿæˆ
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          1. ä¸‹è½½ `AutoYuque_V${{ env.VERSION }}_Windows.zip`
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. é…ç½® `config.json` æ–‡ä»¶
          4. è¿è¡Œ `AutoYuque.exe`
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          - éœ€è¦å®‰è£… Chrome æµè§ˆå™¨
          - é¦–æ¬¡ä½¿ç”¨éœ€è¦ç™»å½•è¯­é›€è´¦å·
          - è¯·åˆç†ä½¿ç”¨ï¼Œéµå®ˆå¹³å°è§„åˆ™
        draft: false
        prerelease: false
        files: |
          AutoYuque_V${{ env.VERSION }}_Windows.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
